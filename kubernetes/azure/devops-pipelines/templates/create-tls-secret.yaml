# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

parameters:
  - name: NAMESPACE
    type: string
    default: 'default'

steps:
  - template: ./utils/set-aks-credentials.yaml
  - task: AzureCLI@2
    displayName: 'Generate TLS Certificate and Create Kubernetes Secret'
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION_NAME)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e
        echo "Generating self-signed TLS certificate"
        THUNDER_HOSTNAME=$(THUNDER_HOSTNAME)
        openssl genrsa -out $THUNDER_HOSTNAME.key 2048
        openssl req -new -x509 -key $THUNDER_HOSTNAME.key -out $THUNDER_HOSTNAME.crt -days 365 \
          -subj "/CN=$THUNDER_HOSTNAME" \
          -addext "subjectAltName=DNS:$THUNDER_HOSTNAME"
        
        echo "Creating or updating Kubernetes TLS secret"
        kubectl create secret tls $(TLS_SECRET_NAME) --cert=$THUNDER_HOSTNAME.crt --key=$THUNDER_HOSTNAME.key -n ${{ parameters.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
