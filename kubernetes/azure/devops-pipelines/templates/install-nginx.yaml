# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

parameters:
  - name: CHART_NAME
    type: string
    default: 'ingress-nginx'
  - name: CHART_VERSION
    type: string
    default: "4.13.2"
  - name: RELEASE_NAME
    type: string
    default: 'internal-nginx-ingress'
  - name: NAMESPACE
    type: string
    default: 'internal-nginx-ingress'
  - name: LB_INTERNAL_IP
    type: string
  - name: LB_INTERNAL_SUBNET
    type: string
  - name: NO_OF_REPLICAS
    type: string
    default: '2'
  - name: AUTOSCALING_ENABLED
    type: string
    default: 'true'

steps:
  - template: ./utils/set-aks-credentials.yaml
  - script: |
      echo '
      controller:
        replicaCount: ${{ parameters.NO_OF_REPLICAS }}
        resources:
          limits:
            cpu: 1000m
            memory: 1000Mi
          requests:
            cpu: 500m
            memory: 500Mi
        autoscaling:
          enabled: ${{ parameters.AUTOSCALING_ENABLED }}
          minReplicas: ${{ parameters.NO_OF_REPLICAS }}
          maxReplicas: 5
          targetCPUUtilizationPercentage: 80
          targetMemoryUtilizationPercentage: 80
        service:
          annotations:
            service.beta.kubernetes.io/azure-load-balancer-internal: "true"
            service.beta.kubernetes.io/azure-load-balancer-internal-subnet: ${{ parameters.LB_INTERNAL_SUBNET }}
            service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: "/healthz"
          externalTrafficPolicy: Local
          loadBalancerIP: ${{ parameters.LB_INTERNAL_IP }}' > $(Agent.TempDirectory)/ingress_helm_values.yaml
    displayName: Generate Helm Values

  - task: AzureCLI@2
    displayName: 'Install Nginx Ingress'
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION_NAME)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -e
        echo "Installing Nginx Ingress Controller..."
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
        helm upgrade --install ${{ parameters.RELEASE_NAME }} ${{ parameters.CHART_NAME }}/ingress-nginx \
          -n ${{ parameters.NAMESPACE }} \
          --create-namespace \
          --version ${{ parameters.CHART_VERSION }} \
          -f $(Agent.TempDirectory)/ingress_helm_values.yaml
        echo "Nginx Ingress Controller installed successfully"
