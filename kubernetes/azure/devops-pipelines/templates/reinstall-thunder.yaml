# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

parameters:
  - name: WORKING_DIRECTORY
    type: string
  - name: RELEASE_NAME
    type: string
    default: 'thunder-perf'
  - name: NAMESPACE
    type: string
    default: 'default'
  - name: THUNDER_REPLICAS
    type: string
    default: '2'
  - name: THUNDER_CPU_LIMITS
    type: string
    default: '1.5'
  - name: THUNDER_CPU_REQUESTS
    type: string
    default: '1'
  - name: THUNDER_MEMORY_LIMITS
    type: string
    default: '512Mi'
  - name: THUNDER_MEMORY_REQUESTS
    type: string
    default: '256Mi'
  - name: THUNDER_HPA_ENABLED
    type: string
    default: 'true'
  - name: THUNDER_HPA_MAX_REPLICAS
    type: string
    default: '10'
  - name: THUNDER_HPA_CPU_UTILIZATION
    type: string
    default: '65'
  - name: THUNDER_HPA_MEMORY_UTILIZATION
    type: string
    default: '75'

steps:
  - template: ./utils/set-aks-credentials.yaml
  - task: AzureCLI@2
    displayName: 'Uninstall Thunder'
    inputs:
      azureSubscription: $(AZURE_SERVICE_CONNECTION_NAME)
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      workingDirectory: ${{ parameters.WORKING_DIRECTORY }}
      inlineScript: |
        echo "Uninstalling Thunder Helm Chart"
        if ! helm uninstall ${{ parameters.RELEASE_NAME }} \
          --namespace ${{ parameters.NAMESPACE }}; then
          echo "Error: Failed to uninstall Thunder Helm Chart"
          exit 1
        fi
        echo "Waiting for 10 seconds to ensure complete uninstallation"
        sleep 10
        echo "Uninstallation completed"

  - template: ./install-thunder.yaml
    parameters:
      WORKING_DIRECTORY: ${{ parameters.WORKING_DIRECTORY }}
      RELEASE_NAME: ${{ parameters.RELEASE_NAME }}
      NAMESPACE: ${{ parameters.NAMESPACE }}
      THUNDER_REPLICAS: ${{ parameters.THUNDER_REPLICAS }}
      THUNDER_CPU_LIMITS: ${{ parameters.THUNDER_CPU_LIMITS }}
      THUNDER_CPU_REQUESTS: ${{ parameters.THUNDER_CPU_REQUESTS }}
      THUNDER_MEMORY_LIMITS: ${{ parameters.THUNDER_MEMORY_LIMITS }}
      THUNDER_MEMORY_REQUESTS: ${{ parameters.THUNDER_MEMORY_REQUESTS }}
      THUNDER_HPA_ENABLED: ${{ parameters.THUNDER_HPA_ENABLED }}
      THUNDER_HPA_MAX_REPLICAS: ${{ parameters.THUNDER_HPA_MAX_REPLICAS }}
      THUNDER_HPA_CPU_UTILIZATION: ${{ parameters.THUNDER_HPA_CPU_UTILIZATION }}
      THUNDER_HPA_MEMORY_UTILIZATION: ${{ parameters.THUNDER_HPA_MEMORY_UTILIZATION }}
