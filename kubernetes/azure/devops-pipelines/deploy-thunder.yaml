# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

trigger: none

pr: none

parameters:
  - name: INSTALL_INTERNAL_NGINX_INGRESS
    displayName: Install Internal NGINX Ingress Controller
    type: boolean
    default: true
  - name: CREATE_TLS_SECRET
    displayName: Create Nginx TLS Secret
    type: boolean
    default: true
  - name: SETUP_DB_SCHEMA
    displayName: Setup Database Schema
    type: boolean
    default: true
  - name: INSTALL_THUNDER
    displayName: Install Thunder
    type: boolean
    default: true
  - name: ADD_HOSTS_ENTRY
    displayName: Add Hosts Entry to VM
    type: boolean
    default: true
  - name: THUNDER_REPO
    type: string
    displayName: "Thunder Repository"
    default: "asgardeo/thunder"
  - name: THUNDER_REPO_BRANCH
    type: string
    displayName: "Thunder Repository Branch"
    default: "main"
  - name: THUNDER_IMAGE_REGISTRY
    type: string
    displayName: "Thunder Image Registry"
    default: "ghcr.io/asgardeo"
  - name: THUNDER_IMAGE_REPOSITORY
    type: string
    displayName: "Thunder Image Repository"
    default: "thunder"
  - name: THUNDER_IMAGE_TAG
    type: string
    displayName: "Thunder Image Tag"
    default: "0.7.0"
  - name: THUNDER_REPLICAS
    type: string
    displayName: "Thunder Replicas"
    default: "2"
  - name: THUNDER_CPU_LIMITS
    type: string
    displayName: "Thunder CPU Limits"
    default: "1.5"
  - name: THUNDER_CPU_REQUESTS
    type: string
    displayName: "Thunder CPU Requests"
    default: "1"
  - name: THUNDER_MEMORY_LIMITS
    type: string
    displayName: "Thunder Memory Limits"
    default: "512Mi"
  - name: THUNDER_MEMORY_REQUESTS
    type: string
    displayName: "Thunder Memory Requests"
    default: "256Mi"
  - name: THUNDER_HPA_ENABLED
    type: string
    displayName: "Thunder HPA Enabled"
    default: "true"
  - name: THUNDER_HPA_MAX_REPLICAS
    type: string
    displayName: "Thunder HPA Max Replicas"
    default: "10"
  - name: THUNDER_HPA_CPU_UTILIZATION
    type: string
    displayName: "Thunder HPA CPU Utilization"
    default: "65"
  - name: THUNDER_HPA_MEMORY_UTILIZATION
    type: string
    displayName: "Thunder HPA Memory Utilization"
    default: "75"

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: vg-thunder-perf
  - group: vg-thunder-perf-secrets
  - template: ./variables.yaml
  - name: THUNDER_REPO
    value: ${{parameters.THUNDER_REPO}}
  - name: THUNDER_REPO_BRANCH
    value: ${{parameters.THUNDER_REPO_BRANCH}}
  - name: THUNDER_IMAGE_REGISTRY
    value: ${{parameters.THUNDER_IMAGE_REGISTRY}}
  - name: THUNDER_IMAGE_REPOSITORY
    value: ${{parameters.THUNDER_IMAGE_REPOSITORY}}
  - name: THUNDER_IMAGE_TAG
    value: ${{parameters.THUNDER_IMAGE_TAG}}
  - name: THUNDER_REPLICAS
    value: ${{parameters.THUNDER_REPLICAS}}
  - name: THUNDER_CPU_LIMITS
    value: ${{parameters.THUNDER_CPU_LIMITS}}
  - name: THUNDER_CPU_REQUESTS
    value: ${{parameters.THUNDER_CPU_REQUESTS}}
  - name: THUNDER_MEMORY_LIMITS
    value: ${{parameters.THUNDER_MEMORY_LIMITS}}
  - name: THUNDER_MEMORY_REQUESTS
    value: ${{parameters.THUNDER_MEMORY_REQUESTS}}
  - name: THUNDER_HPA_ENABLED
    value: ${{parameters.THUNDER_HPA_ENABLED}}
  - name: THUNDER_HPA_MAX_REPLICAS
    value: ${{parameters.THUNDER_HPA_MAX_REPLICAS}}
  - name: THUNDER_HPA_CPU_UTILIZATION
    value: ${{parameters.THUNDER_HPA_CPU_UTILIZATION}}
  - name: THUNDER_HPA_MEMORY_UTILIZATION
    value: ${{parameters.THUNDER_HPA_MEMORY_UTILIZATION}}

resources:
  repositories:
    - repository: thunder-repo
      type: github
      endpoint: asgardeo
      name: $(THUNDER_REPO)
      ref: $(THUNDER_REPO_BRANCH)

jobs:
  - job: create_tls_secret
    condition: eq('${{ parameters.CREATE_TLS_SECRET }}', true)
    displayName: Create Nginx TLS Secret
    steps:
      - template: './templates/create-tls-secret.yaml'

  - job: install_nginx
    condition: eq('${{ parameters.INSTALL_INTERNAL_NGINX_INGRESS }}', true)
    displayName: Install NGINX Ingress Controller
    steps:
      - template: './templates/install-nginx.yaml'
        parameters:
          LB_INTERNAL_IP: $(INTERNAL_NGINX_CONTROLLER_LB_INTERNAL_IP)
          LB_INTERNAL_SUBNET: $(INTERNAL_NGINX_CONTROLLER_LB_INTERNAL_SUBNET)

  - job: setup_db_schema
    displayName: Setup Database Schema
    condition: eq('${{ parameters.SETUP_DB_SCHEMA }}', true)
    steps:
      - checkout: thunder-repo
        path: "thunder-repo"
      - template: './templates/setup-db-schema.yaml'
        parameters:
          WORKING_DIRECTORY: $(Agent.BuildDirectory)/thunder-repo/backend

  - job: install_thunder
    displayName: Install Thunder
    dependsOn: setup_db_schema
    condition: eq('${{ parameters.INSTALL_THUNDER }}', true)
    steps:
      - checkout: thunder-repo
        path: "thunder-repo"
      - template: './templates/install-thunder.yaml'
        parameters:
          WORKING_DIRECTORY: $(Agent.BuildDirectory)/thunder-repo/install/helm

  - job: add_hosts_entry_to_vm
    displayName: Add Hosts Entry to VM
    dependsOn: install_thunder
    condition: eq('${{ parameters.ADD_HOSTS_ENTRY }}', true)
    steps:
      - template: './templates/add-hosts-entry-to-vm.yaml'
